
<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Zones dâ€™intervention â€“ SOGEA</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
:root {
  --primary: #003a8f;
  --secondary: #f4f6f8;
  --accent: #2ecc71;
}

body {
  margin: 0;
  font-family: "Segoe UI", Roboto, Arial, sans-serif;
  background: var(--secondary);
}

/* HEADER */
header {
  background: white;
  display: flex;
  align-items: center;
  gap: 15px;
  padding: 12px 16px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.08);
}

header img {
  height: 40px;
}

header h1 {
  font-size: 18px;
  margin: 0;
  color: var(--primary);
}

/* MAIN */
main {
  padding: 15px;
}

.card {
  background: white;
  border-radius: 14px;
  padding: 15px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.08);
  margin-bottom: 15px;
}

label {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 14px;
}

input[type="text"] {
  width: 100%;
  padding: 12px;
  margin-top: 10px;
  border-radius: 10px;
  border: 1px solid #ccc;
  font-size: 16px;
}

button {
  width: 100%;
  margin-top: 12px;
  padding: 14px;
  border-radius: 12px;
  border: none;
  background: var(--primary);
  color: white;
  font-size: 16px;
  cursor: pointer;
}

button:hover {
  opacity: 0.9;
}

#result {
  margin-top: 12px;
  font-size: 16px;
  font-weight: 600;
}

#map {
  height: 55vh;
  border-radius: 16px;
  overflow: hidden;
}

/* FOOTER */
footer {
  text-align: center;
  padding: 10px;
  font-size: 12px;
  color: #777;
}
</style>
</head>

<body>

<header>
  <img src="sogea-logo.png" alt="SOGEA">
  <h1>Zones dâ€™intervention â€“ Krautergersheim</h1>
</header>

<main>

  <div class="card">
    <label>
      <input type="checkbox" id="geo">
      Utiliser ma gÃ©olocalisation
    </label>

    <input type="text" id="input" placeholder="Ville, village ou adresse complÃ¨te">

    <button onclick="search()">VÃ©rifier la zone</button>

    <div id="result"></div>
  </div>

  <div id="map"></div>

</main>

<footer>
  Â© SOGEA â€“ Outil interne de zonage
</footer>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const center = [48.472359843250466, 7.593746957672707];
const zoneRadii = [10,20,30,40,50,60];
const colors = ['#2ecc71','#27ae60','#f1c40f','#e67e22','#e74c3c','#8e44ad'];

const map = L.map('map').setView(center, 8);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: 'Â© OpenStreetMap'
}).addTo(map);

L.marker(center).addTo(map).bindPopup("Agence SOGEA â€“ Krautergersheim");

zoneRadii.forEach((r,i)=>{
  L.circle(center,{
    radius: r*1000,
    color: colors[i],
    fillOpacity: 0.15
  }).addTo(map).bindPopup(`Zone ${i+1} â€“ ${r} km`);
});

let marker;

function search() {
  document.getElementById("result").innerText = "";
  if (marker) map.removeLayer(marker);

  if (document.getElementById("geo").checked) {
    navigator.geolocation.getCurrentPosition(
      pos => handlePoint(pos.coords.latitude, pos.coords.longitude),
      () => document.getElementById("result").innerText = "ðŸ“ Position indisponible",
      { enableHighAccuracy: true, timeout: 10000 }
    );
    return;
  }

  const q = document.getElementById("input").value.trim();
  if (!q) return;

  fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&countrycodes=fr,de&limit=1`)
    .then(r=>r.json())
    .then(data=>{
      if (!data.length) {
        document.getElementById("result").innerText = "âŒ Lieu non trouvÃ©";
        return;
      }
      handlePoint(parseFloat(data[0].lat), parseFloat(data[0].lon));
    });
}

function handlePoint(lat, lon) {
  marker = L.marker([lat,lon]).addTo(map);
  map.setView([lat,lon], 9);

  const distKm = map.distance(center,[lat,lon]) / 1000;
  let zone = null;

  zoneRadii.forEach((r,i)=>{
    if (!zone && distKm <= r) zone = i+1;
  });

  if (zone) {
    document.getElementById("result").innerText =
      `âœ… Zone ${zone} â€“ ${zone*10} km`;
  } else {
    const from = destinationPoint(center, 60, bearing(center,[lat,lon]));
    routeTime(from,[lat,lon]);
  }
}

function bearing(a,b){
  const toRad = d => d*Math.PI/180;
  const y = Math.sin(toRad(b[1]-a[1])) * Math.cos(toRad(b[0]));
  const x = Math.cos(toRad(a[0]))*Math.sin(toRad(b[0])) -
            Math.sin(toRad(a[0]))*Math.cos(toRad(b[0]))*Math.cos(toRad(b[1]-a[1]));
  return (Math.atan2(y,x)*180/Math.PI+360)%360;
}

function destinationPoint(start, distKm, brng){
  const R = 6371;
  const toRad = d => d*Math.PI/180;
  const toDeg = r => r*180/Math.PI;

  const lat1 = toRad(start[0]);
  const lon1 = toRad(start[1]);
  const br = toRad(brng);
  const d = distKm/R;

  const lat2 = Math.asin(Math.sin(lat1)*Math.cos(d)+Math.cos(lat1)*Math.sin(d)*Math.cos(br));
  const lon2 = lon1 + Math.atan2(Math.sin(br)*Math.sin(d)*Math.cos(lat1),Math.cos(d)-Math.sin(lat1)*Math.sin(lat2));

  return [toDeg(lat2),toDeg(lon2)];
}

function routeTime(from,to){
  fetch(`https://router.project-osrm.org/route/v1/driving/${from[1]},${from[0]};${to[1]},${to[0]}?overview=false`)
    .then(r=>r.json())
    .then(data=>{
      const min = Math.round(data.routes[0].duration/60);
      document.getElementById("result").innerText =
        `ðŸš— Hors zone (+60 km)\nTemps de trajet depuis la limite zone 6 : ${min} min`;
    });
}
</script>

</body>
</html>
