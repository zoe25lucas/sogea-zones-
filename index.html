

<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Zones dâ€™intervention â€“ SOGEA</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
:root {
  --blue:#003a8f;
  --bg:#f4f6f8;
}
body {
  margin:0;
  font-family:Segoe UI, Roboto, Arial, sans-serif;
  background:var(--bg);
}
header {
  background:white;
  padding:12px 16px;
  display:flex;
  align-items:center;
  gap:15px;
  box-shadow:0 2px 10px rgba(0,0,0,0.08);
}
header img { height:40px; }
header h1 { font-size:18px; margin:0; color:var(--blue); }

main { padding:15px; }

.card {
  background:white;
  border-radius:14px;
  padding:15px;
  box-shadow:0 6px 20px rgba(0,0,0,0.08);
  margin-bottom:15px;
}

input, button {
  width:100%;
  padding:12px;
  margin-top:10px;
  border-radius:10px;
  border:1px solid #ccc;
  font-size:15px;
}

button {
  background:var(--blue);
  color:white;
  border:none;
  cursor:pointer;
}

label {
  display:block;
  margin-top:8px;
}

#result {
  margin-top:12px;
  font-weight:600;
  white-space:pre-line;
}

#map {
  height:55vh;
  border-radius:16px;
}

footer {
  text-align:center;
  font-size:12px;
  color:#777;
  padding:10px;
}
</style>
</head>

<body>

<header>
  <img src="sogea-logo.png" alt="SOGEA">
  <h1>Zones dâ€™intervention â€“ SOGEA</h1>
</header>

<main>

<div class="card">
  <strong>Agences :</strong>
  <label><input type="checkbox" id="kraut" checked> Krautergersheim</label>
  <label><input type="checkbox" id="rich" checked> Richwiller</label>

  <label style="margin-top:10px;">
    <input type="checkbox" id="geo" onchange="toggleInput()"> Utiliser ma gÃ©olocalisation
  </label>

  <!-- Champ texte masquable -->
  <input id="input" placeholder="Ville, village ou adresse complÃ¨te">

  <button onclick="search()">VÃ©rifier la zone</button>

  <div id="result"></div>
</div>

<div id="map"></div>

</main>

<footer>Â© SOGEA</footer>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
/* ================= DONNÃ‰ES ================= */

const agencies = [
  { id:"kraut", name:"Krautergersheim", coord:[48.47236,7.59375] },
  { id:"rich", name:"Richwiller", coord:[47.7786,7.3125] }
];

const zoneRadii = [10,20,30,40,50,60];

/* ================= CARTE ================= */

const map = L.map('map').setView([48.3,7.6],8);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  attribution:'Â© OpenStreetMap'
}).addTo(map);

let targetMarker;

/* ================= UI ================= */

function toggleInput(){
  const geo = document.getElementById("geo").checked;
  const input = document.getElementById("input");

  if (geo) {
    input.style.display = "none";
    input.value = "";
  } else {
    input.style.display = "block";
  }
}

/* ================= LOGIQUE ================= */

function search(){
  const result = document.getElementById("result");
  result.innerText = "";

  if (targetMarker) map.removeLayer(targetMarker);

  if (document.getElementById("geo").checked) {
    navigator.geolocation.getCurrentPosition(
      pos => handleGeo(pos.coords.latitude, pos.coords.longitude),
      () => result.innerText = "ðŸ“ GÃ©olocalisation indisponible",
      { enableHighAccuracy:true, timeout:10000 }
    );
    return;
  }

  const q = input.value.trim();
  if (!q) return;

  fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&countrycodes=fr,de&limit=1`)
    .then(r => r.json())
    .then(d => {
      if (!d.length) {
        result.innerText = "âŒ Lieu non trouvÃ©";
        return;
      }
      handlePoint(+d[0].lat, +d[0].lon);
    });
}

/* ================= GÃ‰OLOCALISATION ================= */

function handleGeo(lat, lon){
  const result = document.getElementById("result");
  result.innerText = "ðŸ“ Position dÃ©tectÃ©e...\n";

  fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`)
    .then(r => r.json())
    .then(d => {
      const city =
        d.address?.city ||
        d.address?.town ||
        d.address?.village ||
        d.address?.municipality ||
        "Lieu inconnu";

      result.innerText = `ðŸ“ Vous Ãªtes Ã  ${city}\n\n`;
      handlePoint(lat, lon);
    });
}

/* ================= CALCUL ZONES ================= */

function handlePoint(lat, lon){
  if (targetMarker) map.removeLayer(targetMarker);
  targetMarker = L.marker([lat, lon]).addTo(map);
  map.setView([lat, lon], 9);

  const result = document.getElementById("result");

  agencies.forEach(a => {
    if (!document.getElementById(a.id).checked) return;

    const dist = map.distance(a.coord, [lat, lon]) / 1000;
    let zone = null;

    zoneRadii.forEach((r, i) => {
      if (!zone && dist <= r) zone = i + 1;
    });

    if (zone) {
      result.innerText += `âœ” ${a.name} â†’ Zone ${zone} (${zone*10} km)\n`;
    } else {
      const from = destinationPoint(a.coord, 60, bearing(a.coord, [lat, lon]));
      routeTime(from, [lat, lon], a.name);
    }
  });
}

/* ================= TEMPS ROUTIER ================= */

function routeTime(from, to, name){
  fetch(`https://router.project-osrm.org/route/v1/driving/${from[1]},${from[0]};${to[1]},${to[0]}?overview=false`)
    .then(r => r.json())
    .then(d => {
      const min = Math.round(d.routes[0].duration / 60);
      document.getElementById("result").innerText +=
        `âŒ ${name} â†’ Hors zone (+60 km) â€“ ${min} min\n`;
    });
}

/* ================= MATHS ================= */

function bearing(a,b){
  const toRad=d=>d*Math.PI/180;
  const y=Math.sin(toRad(b[1]-a[1]))*Math.cos(toRad(b[0]));
  const x=Math.cos(toRad(a[0]))*Math.sin(toRad(b[0]))-
          Math.sin(toRad(a[0]))*Math.cos(toRad(b[0]))*Math.cos(toRad(b[1]-a[1]));
  return (Math.atan2(y,x)*180/Math.PI+360)%360;
}

function destinationPoint(start, distKm, brng){
  const R=6371, toRad=d=>d*Math.PI/180, toDeg=r=>r*180/Math.PI;
  const lat1=toRad(start[0]), lon1=toRad(start[1]), br=toRad(brng), d=distKm/R;
  const lat2=Math.asin(Math.sin(lat1)*Math.cos(d)+Math.cos(lat1)*Math.sin(d)*Math.cos(br));
  const lon2=lon1+Math.atan2(Math.sin(br)*Math.sin(d)*Math.cos(lat1),Math.cos(d)-Math.sin(lat1)*Math.sin(lat2));
  return [toDeg(lat2), toDeg(lon2)];
}
</script>

</body>
</html>
