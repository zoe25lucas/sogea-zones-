<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<title>Zones SOGEA â€“ Krautergersheim</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
}
#controls {
  padding: 10px;
  background: #f4f4f4;
}
#map {
  height: 85vh;
}
#result {
  margin-left: 10px;
  font-weight: bold;
}
</style>
</head>

<body>

<div id="controls">
  <label>
    <input type="radio" name="mode" value="city" checked>
    Ville / village
  </label>

  <label>
    <input type="radio" name="mode" value="address">
    Adresse complÃ¨te
  </label>

  <label>
    <input type="radio" name="mode" value="geo">
    Me gÃ©olocaliser
  </label>

  <br><br>

  <input id="input" type="text"
         placeholder="Ville, village ou adresse"
         style="width:320px">

  <button onclick="search()">Valider</button>

  <span id="result"></span>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// ============================
// ðŸ“ CENTRE SOGEA KRAUTERGERSHEIM
// ============================
const CENTER = [48.472359843250466, 7.593746957672707];

// ============================
// ðŸ—ºï¸ CARTE
// ============================
const map = L.map('map').setView(CENTER, 9);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: 'Â© OpenStreetMap'
}).addTo(map);

L.marker(CENTER)
  .addTo(map)
  .bindPopup("SOGEA â€“ Krautergersheim");

// ============================
// ðŸŒ€ ZONES 1 â†’ 6 (10 km)
// ============================
const ZONES = [
  { limit: 10000, label: "Zone 1 (0â€“10 km)", color: "#2ecc71" },
  { limit: 20000, label: "Zone 2 (10â€“20 km)", color: "#27ae60" },
  { limit: 30000, label: "Zone 3 (20â€“30 km)", color: "#f1c40f" },
  { limit: 40000, label: "Zone 4 (30â€“40 km)", color: "#e67e22" },
  { limit: 50000, label: "Zone 5 (40â€“50 km)", color: "#e74c3c" },
  { limit: 60000, label: "Zone 6 (50â€“60 km)", color: "#8e44ad" }
];

ZONES.forEach(z => {
  L.circle(CENTER, {
    radius: z.limit,
    color: z.color,
    fill: false
  }).addTo(map).bindPopup(z.label);
});

let marker;

// ============================
// ðŸ“ DISTANCE VOL Dâ€™OISEAU
// ============================
function haversine(lat1, lon1, lat2, lon2) {
  const R = 6371000;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a =
    Math.sin(dLat / 2) ** 2 +
    Math.cos(lat1 * Math.PI / 180) *
    Math.cos(lat2 * Math.PI / 180) *
    Math.sin(dLon / 2) ** 2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

// ============================
// ðŸ” ACTION PRINCIPALE
// ============================
function search() {
  const mode = document.querySelector('input[name="mode"]:checked').value;

  if (mode === "geo") {
    geolocate();
    return;
  }

  const query = document.getElementById("input").value.trim();
  if (!query) return;

  fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=fr&limit=1`)
    .then(r => r.json())
    .then(d => {
      if (!d.length) {
        document.getElementById("result").textContent = "Lieu non trouvÃ©";
        return;
      }
      handleLocation(
        parseFloat(d[0].lat),
        parseFloat(d[0].lon),
        d[0].display_name
      );
    });
}

// ============================
// ðŸ“ GÃ‰OLOCALISATION ROBUSTE
// ============================
function geolocate() {
  if (!navigator.geolocation) {
    alert("GÃ©olocalisation non supportÃ©e");
    return;
  }

  navigator.geolocation.getCurrentPosition(
    pos => {
      handleLocation(
        pos.coords.latitude,
        pos.coords.longitude,
        "Votre position actuelle"
      );
    },
    err => {
      if (err.code === 1) alert("Autorisation refusÃ©e");
      else if (err.code === 2) alert("Position indisponible");
      else alert("Erreur de gÃ©olocalisation");
    },
    {
      enableHighAccuracy: true,
      timeout: 10000,
      maximumAge: 0
    }
  );
}

// ============================
// ðŸ§  LOGIQUE ZONES / ROUTE
// ============================
function handleLocation(lat, lon, label) {
  if (marker) map.removeLayer(marker);

  marker = L.marker([lat, lon])
    .addTo(map)
    .bindPopup(label)
    .openPopup();

  map.setView([lat, lon], 9);

  const distance = haversine(
    CENTER[0], CENTER[1],
    lat, lon
  );

  for (let z of ZONES) {
    if (distance <= z.limit) {
      document.getElementById("result").textContent =
        `ðŸ“ ${label} â†’ ${z.label}`;
      return;
    }
  }

  // ðŸš— TEMPS PAR LA ROUTE (OSRM)
  fetch(`https://router.project-osrm.org/route/v1/driving/${CENTER[1]},${CENTER[0]};${lon},${lat}?overview=false`)
    .then(r => r.json())
    .then(d => {
      const minutes = Math.round(d.routes[0].duration / 60);
      document.getElementById("result").textContent =
        `ðŸš— Hors zone 6 â†’ +${minutes} min de trajet (par la route)`;
    });
}
</script>

</body>
</html>
